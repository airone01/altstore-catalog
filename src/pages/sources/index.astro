---
import { getCollection } from "astro:content";
import Header from "@/components/Header.astro";
import { Card, CardContent } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { AuroraBackground } from "@/components/ui/aurora-background";
import { SourceAddButton } from "@/components/source-add-button";
import SourceCard from "@/components/SourceCard.astro";
import "@/styles/global.css";

const sources = await getCollection("sources");
const sortedSources = sources.sort(
  (a, b) => b.data.lastUpdated.getTime() - a.data.lastUpdated.getTime(),
);

// Group sources by category
const sourcesByCategory = sortedSources.reduce(
  (acc, source) => {
    const category = source.data.category;
    if (!acc[category]) {
      acc[category] = [];
    }
    acc[category].push(source);
    return acc;
  },
  {} as Record<string, typeof sources>,
);

const categories = Object.keys(sourcesByCategory).sort();
const totalApps = 999;
const verifiedSources = sources.filter((source) => source.data.verified).length;
---

<html lang="en" class="h-full">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />
    <title>Sources - Ascend</title>
    <meta
      name="description"
      content="Browse sources for AltStore and AltStore PAL"
    />
  </head>

  <body class="h-full min-h-screen">
    <AuroraBackground
      children={[]}
      className="h-full w-full top-0 left-0 fixed -z-10"
    />

    <!-- Navigation -->
    <Header currentPath="sources" />

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
      <div class="mb-8">
        <div class="flex items-center justify-between mb-4">
          <h1 class="scroll-m-20 text-4xl font-extrabold tracking-tight">
            Sources
          </h1>
        </div>
        <p class="text-xl text-muted-foreground mb-6">
          Discover sources to your AltStore or AltStore PAL. Sources are
          collections of apps curated by developers and communities.
        </p>
      </div>

      <!-- Sources by Category -->
      {
        categories.map((category) => (
          <section class="mb-12">
            <h2 class="scroll-m-20 text-2xl font-semibold tracking-tight mb-6">
              {category}
            </h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              {sourcesByCategory[category].map((source) => (
                <SourceCard
                  source={source}
                  loading={category === "Developer" ? "eager" : "lazy"}
                />
              ))}
            </div>
          </section>
        ))
      }

      {
        sources.length === 0 && (
          <div class="text-center py-12">
            <h3 class="text-lg font-semibold mb-2">No sources found</h3>
          </div>
        )
      }
    </main>

    <!-- Footer -->
    <footer class="mt-16 border-t bg-background/50 backdrop-blur-sm">
      <div class="container mx-auto px-4 py-8">
        <div class="text-center text-sm text-muted-foreground">
          <p>Community-maintained catalog for AltStore & AltStore PAL</p>
          <p class="mt-2">
            <a href="/" class="hover:text-foreground transition-colors">Home</a>
            •
            <a href="/apps" class="hover:text-foreground transition-colors ml-1"
              >Apps</a
            > •
            <a
              href="/sources"
              class="hover:text-foreground transition-colors ml-1">Sources</a
            >
          </p>
        </div>
      </div>
    </footer>
  </body>
</html>

<style>
  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
